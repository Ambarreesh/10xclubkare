<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EDU HACK|10X CLUB KARE</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Rubik+Glitch&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  :root {
    --st-red: #ff0033;
    --st-glow: rgba(255, 0, 51, 0.6);
    --bg-dark: #050505;
    --glass-surface: rgba(20, 20, 20, 0.7);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-primary: #f5f5f7;
    --text-secondary: #86868b;
    --radius-lg: 24px;
    --font-main: 'Inter', sans-serif;
    --font-title: 'Rubik Glitch', cursive;
    --ease-apple: cubic-bezier(0.25, 0.1, 0.25, 1);
  }

  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    font-family: var(--font-main);
    background-color: var(--bg-dark);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
    background: radial-gradient(circle at 50% -20%, #1a0005 0%, #000 80%);
    cursor: default;
  }

  /* --- CRT Scanline Overlay --- */
  body::after {
    content: " ";
    display: block;
    position: fixed;
    top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 2;
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
  }

  /* --- Parallax Fog --- */
  .fog-layer {
    position: fixed;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjAzIi8+PC9zdmc+');
    opacity: 0.35;
    pointer-events: none;
    z-index: 0;
    transition: transform 0.1s ease-out;
  }

  .container {
    max-width: 1080px;
    margin: 0 auto;
    padding: 40px 20px 120px;
    position: relative;
    z-index: 3;
    opacity: 0;
    animation: fadeIn 1.2s var(--ease-apple) forwards;
  }

  @keyframes fadeIn { to { opacity: 1; } }

  /* --- Glitch Title --- */
  .glitch-title {
    font-family: var(--font-title);
    font-size: 3.5rem;
    margin: 0;
    color: #fff;
    text-shadow: 2px 2px 0px var(--st-red);
    animation: glitch 4s infinite;
  }
  @keyframes glitch {
    0% { text-shadow: 2px 2px 0px var(--st-red); }
    5% { text-shadow: -2px -2px 0px #00ccff; }
    10% { text-shadow: 2px 2px 0px var(--st-red); }
    100% { text-shadow: 2px 2px 0px var(--st-red); }
  }

  /* --- Glass Cards --- */
  .glass-card {
    background: var(--glass-surface);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    transition: all 0.4s var(--ease-apple);
    overflow: hidden;
  }
  .glass-card:hover {
    box-shadow: 0 30px 80px rgba(255, 0, 51, 0.15);
    border-color: rgba(255, 0, 51, 0.3);
    transform: translateY(-2px);
  }

  header.hero { display: flex; justify-content: space-between; align-items: center; padding: 40px 0; gap: 20px; flex-wrap: wrap; }
  .logos { display: flex; gap: 20px; align-items: center; }
  .logos img { height: 50px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
   
  .tagline { font-size: 0.95rem; color: var(--text-secondary); margin-top: 10px; display: flex; align-items: center; gap: 10px; justify-content: flex-end;}
  .tagline span { background: rgba(255,0,51,0.1); color: var(--st-red); padding: 4px 12px; border-radius: 99px; font-size: 0.8rem; font-weight: 700; border: 1px solid rgba(255,0,51,0.2); }

  .grid { display: grid; grid-template-columns: 1fr 1.4fr; gap: 32px; }
   
  .info-content { padding: 40px; }
  .info-content img { width: 100%; border-radius: 18px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit: cover; }
  .info-list { padding:0; list-style:none; }
  .info-list li { padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.06); color: var(--text-secondary); display: flex; justify-content: space-between; font-size: 0.95rem; }
  .info-list li strong { color: #fff; }

  .form-padding { padding: 40px; }
  h2 { font-size: 1.6rem; margin: 0 0 30px 0; color: #fff; }

  .field-group { margin-bottom: 24px; }
  label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; letter-spacing: 0.5px; }
  input, select {
    width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 14px; padding: 16px; color: #fff; font-size: 1rem; font-family: var(--font-main);
    transition: 0.3s;
  }
  input:focus, select:focus { border-color: var(--st-red); box-shadow: 0 0 0 4px rgba(255, 0, 51, 0.15); background: rgba(0,0,0,0.7); }

  .btn { border: none; cursor: pointer; font-family: var(--font-main); font-weight: 600; padding: 16px 28px; border-radius: 99px; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; }
  .btn-primary { background: var(--st-red); color: #fff; box-shadow: 0 4px 20px rgba(255, 0, 51, 0.3); }
  .btn-primary:hover { background: #ff1f4b; transform: scale(1.02); box-shadow: 0 8px 30px rgba(255, 0, 51, 0.5); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
   
  .btn-ghost { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
  .btn-ghost:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
   
  .btn-text { background: transparent; color: var(--st-red); padding: 8px 12px; font-size: 0.85rem; }
  .btn-text:hover { text-decoration: underline; }

  .member-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 14px 18px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* --- Modals --- */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: 0.3s; }
  .modal-overlay.active { opacity: 1; }
   
  .modal { width: 90%; max-width: 480px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; padding: 32px; box-shadow: 0 40px 80px rgba(0,0,0,1); transform: scale(0.95); transition: 0.3s var(--ease-apple); position: relative; }
  .modal-overlay.active .modal { transform: scale(1); }
   
  .close-btn { position: absolute; top: 20px; right: 24px; width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; transition: 0.2s; }
  .close-btn:hover { background: var(--st-red); }

  /* --- Toast Notifications --- */
  #toast-container { position: fixed; top: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
  .toast {
    background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
    border-left: 4px solid var(--st-red); border-radius: 8px;
    padding: 16px 20px; min-width: 300px;
    color: #fff; font-size: 0.9rem; font-weight: 500;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    transform: translateX(100%); opacity: 0;
    transition: all 0.4s var(--ease-apple);
    display: flex; align-items: center; gap: 12px;
  }
  .toast.show { transform: translateX(0); opacity: 1; }
  .toast.success { border-color: #00e676; }
  .toast.error { border-color: #ff0033; }

  @media(max-width: 600px){ h1 { font-size: 2.2rem; } .grid { grid-template-columns: 1fr; } .form-padding { padding: 24px; } }
</style>
</head>
<body>

<div class="fog-layer" id="fog"></div>

<div id="toast-container"></div>

<div class="container">
  <header class="hero">
    <div class="logos">
      <img src="img/klu.png" alt="KARE">
      <img src="img/image 26.png" alt="10X Club">
    </div>
    <div style="flex:1; text-align: right;">
      <h1 class="glitch-title">EDU HACK</h1>
      <div class="tagline">
        24HR HACKATHON <span>30-31 JAN 2026</span>
      </div>
    </div>
  </header>

  <div class="grid">
    <section class="glass-card">
      <div class="info-content">
        <img src="img/edu.png" alt="Event Poster" />
        <h2 style="font-family: var(--font-title); color: var(--st-red); font-size: 2rem;">MISSION BRIEF</h2>
        <ul class="info-list">
          <li><span>Objective</span> <strong>Build innovative campus apps</strong></li>
          <li><span>Squad Size</span> <strong>3 - 4 Members</strong></li>
          <li><span>Entry Fee</span> <strong>₹300 / Agent</strong></li>
          <li><span>Venue</span> <strong>8th Block Seminar Hall</strong></li>
          <li><span>Note</span><strong>Team Captain Name Should be First</strong></li>
        </ul>
      </div>
    </section>

    <section class="glass-card">
      <form id="regForm" class="form-padding">
        <h2>Squad Registration</h2>
        <div class="field-group">
          <label>Team Name</label>
          <input id="teamName" placeholder="e.g. Hawkins High AV Club" autocomplete="off" />
        </div>

        <div class="field-group">
          <label style="display:flex; justify-content:space-between;">Squad Members <span>(Max 4)</span></label>
          <ul id="teamList" style="list-style:none; padding:0; margin:0 0 16px 0;"></ul>
          <div style="display:flex; gap:10px;">
            <button type="button" class="btn btn-ghost" id="addMemberBtn" style="flex:1;">+ Add Agent</button>
            <button type="button" class="btn btn-ghost" id="clearMembersBtn" style="color:#ff9999;">Clear</button>
          </div>
        </div>

        <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:20px; display:flex; justify-content:space-between; align-items:center; margin:30px 0;">
          <span style="color:var(--text-secondary);">Total Fee</span>
          <span id="totalAmountDisplay" style="font-size: 1.8rem; font-weight: 700;">₹ 0</span>
        </div>

        <button type="button" class="btn btn-primary" id="payBtn" style="width:100%;" disabled>Proceed to Payment &rarr;</button>
      </form>
    </section>
  </div>
   
  <footer>
    <center><p style="color:var(--text-secondary); opacity:0.6; margin-top:50px;">&copy; 2026 10X Club KARE.All Rights Reserved.</p></center>
  </footer>
</div>

<div class="modal-overlay" id="memberOverlay">
  <div class="modal">
    <div class="close-btn" id="closeMember">&times;</div>
    <h3>New Agent Profile</h3>
    <div style="display:grid; gap:16px; margin-top:20px;">
      <input id="memberName" placeholder="Full Name" />
      <input id="memberRegno" placeholder="Register No. (10-13 Digits)" maxlength="13" />
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
        <select id="memberDept"><option value="">Dept</option><option>CSE</option><option>IT</option><option>ECE</option><option>EEE</option><option>MECH</option><option>CIVIL</option><option>BioTech</option><option>FoodTech</option><option>BioMed</option><option>Other</option></select>
        <select id="memberYear"><option value="">Year</option><option>1st</option><option>2nd</option><option>3rd</option><option>4th</option></select>
      </div>
      <input id="memberEmail" type="email" placeholder="email@klu.ac.in" />
      <button class="btn btn-primary" id="saveMember">Add to Squad</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="paymentOverlay">
  <div class="modal">
    <div class="close-btn" id="closePayment">&times;</div>
    <h3>Secure Transmission</h3>
    
    <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:16px; display:flex; gap:20px; margin:20px 0; align-items:center;">
      <div id="qrcode" style="background:#fff; padding:8px; border-radius:8px;"></div>
      <div style="flex:1;">
        <div style="color:var(--st-red); font-weight:bold; font-size:0.9rem; letter-spacing:1px; margin-bottom:5px;">SCAN TO PAY</div>
        <div id="payModalAmount" style="font-size:1.4rem; font-weight:700; color:#fff; margin-bottom:5px;"></div>
        <div style="font-size:0.85rem; color:var(--text-secondary);">UPI ID: <span id="upiText" style="color:#fff;"></span></div>
      </div>
    </div>

    <form id="paymentForm" style="display:flex; flex-direction:column; gap:16px;">
      <div class="field-group" style="margin:0;">
        <label>Transaction / UTR ID</label>
        <input id="txnId" required placeholder="e.g. 3245XXXXXXXX" autocomplete="off" />
      </div>
      <div class="field-group" style="margin:0;">
        <label>Payer Name (Optional)</label>
        <input id="payerName" placeholder="Name on UPI App" autocomplete="off" />
      </div>
      <button type="submit" class="btn btn-primary" id="completePaymentBtn" disabled>Confirm Transmission</button>
    </form>
  </div>
</div>

<div class="modal-overlay" id="successOverlay">
  <div class="modal" style="text-align:center;">
    <div style="width:70px; height:70px; background:var(--st-red); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; box-shadow:0 0 40px var(--st-red);">
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
    </div>
    <h3 style="font-size:1.8rem; margin-bottom:10px;">Registration Secured</h3>
    <p style="color:var(--text-secondary); margin-bottom:24px; line-height:1.6;">Your squad has been entered into the system.<br>Entry passes will be transmitted via email shortly or vist 10xclubkare.vercel.app and download your pass.</p>
    <a href="https://10xclubkare.vercel.app/" style="text-decoration:none;"><button class="btn btn-ghost" style="width:100%;">Return to Base</button></a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBzEwEDcTDs2Y-NUAGZkhQJsFRg6MZxoYE",
  authDomain: "eduhack-432fd.firebaseapp.com",
  projectId: "eduhack-432fd",
  storageBucket: "eduhack-432fd.firebasestorage.app",
  messagingSenderId: "160252785408",
  appId: "1:160252785408:web:6a22e465982e3e510979e5",
  measurementId: "G-WCKZ62NM6N"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const EVENT_ID = "edu-hack-2025";
const MEMBER_FEE = 300;
const UPI_ID = "9789295366@ybl";
const UPI_NAME = "RSUNDARRAJAN";

/* --- SOUNDS (SFX) --- */
const sounds = {
  click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
  error: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'),
  success: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3')
};
Object.values(sounds).forEach(s => s.volume = 0.25); // Lower volume

const playSound = (type) => {
  sounds[type].currentTime = 0;
  sounds[type].play().catch(() => {}); // Catch play-before-interact errors
};

// Attach click sound to all buttons
document.addEventListener('click', (e) => {
  if(e.target.closest('button') || e.target.closest('.close-btn')) playSound('click');
});

/* --- UI HELPERS --- */
const getEl = (id) => document.getElementById(id);

// Toast System
function showToast(msg, type = 'error') {
  playSound(type === 'success' ? 'success' : 'error');
  const container = getEl('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = type === 'success' ? `<span>✅</span> ${msg}` : `<span>⚠️</span> ${msg}`;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 4000);
}

// Modal Toggle
const toggleModal = (id, show) => {
  const el = getEl(id);
  if(show) { el.style.display = 'flex'; setTimeout(()=>el.classList.add('active'),10); }
  else { el.classList.remove('active'); setTimeout(()=>el.style.display = 'none',300); }
};

// Mouse Parallax
document.addEventListener('mousemove', (e) => {
  const x = (e.clientX / window.innerWidth) * 15;
  const y = (e.clientY / window.innerHeight) * 15;
  getEl('fog').style.transform = `translate(${x}px, ${y}px)`;
});

/* --- STATE & AUTO-SAVE --- */
let members = [];
let submitting = false;

// Load from LocalStorage on init
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('eduHackMembers');
  if(saved) { members = JSON.parse(saved); renderMembers(); }
});

/* --- MEMBER LOGIC --- */
getEl('addMemberBtn').addEventListener('click', ()=>toggleModal('memberOverlay',true));
getEl('closeMember').addEventListener('click', ()=>toggleModal('memberOverlay',false));
getEl('closePayment').addEventListener('click', ()=>toggleModal('paymentOverlay',false));
getEl('clearMembersBtn').addEventListener('click', ()=>{ 
  if(confirm("Clear current squad?")) { members = []; renderMembers(); }
});

getEl('saveMember').addEventListener('click', () => {
  // Regex Strict Validation
  const emailRegex = /^[a-zA-Z0-9._%+-]+@klu\.ac\.in$/;
  // UPDATED: Regex to accept 10 to 13 alphanumeric characters
  const regRegex = /^[a-zA-Z0-9]{10,13}$/; 

  const m = {
    name: getEl('memberName').value.trim(),
    reg: (getEl('memberRegno').value||'').trim().toUpperCase(),
    dept: getEl('memberDept').value,
    year: getEl('memberYear').value,
    email: (getEl('memberEmail').value||'').trim().toLowerCase()
  };

  if(!m.name || !m.reg || !m.dept || !m.year || !m.email) return showToast("All fields are required");
  // UPDATED: Validation logic to match new regex and message
  if(!regRegex.test(m.reg)) return showToast("Invalid Register No. (Need 10-13 chars)");
  if(!emailRegex.test(m.email)) return showToast("Use valid KLU Email ID (@klu.ac.in)");
   
  if(members.length >= 4) return showToast("Squad is full (Max 4)");
  if(members.some(x => x.reg === m.reg)) return showToast("Agent already in squad");
  if(members.some(x => x.email === m.email)) return showToast("Email already listed");

  members.push(m);
  renderMembers();
  toggleModal('memberOverlay', false);
   
  // Clear inputs
  ['memberName','memberRegno','memberEmail'].forEach(id => getEl(id).value='');
});

window.removeMember = (i) => { members.splice(i,1); renderMembers(); };

function renderMembers() {
  const list = getEl('teamList');
  list.innerHTML = '';
  members.forEach((m, i) => {
    const li = document.createElement('li');
    li.className = 'member-item';
    li.innerHTML = `
      <div>
        <strong>${m.name}</strong><br>
        <span style="font-size:0.8rem; color:var(--text-secondary);">${m.reg} • ${m.dept}</span>
      </div>
      <button class="btn btn-text" onclick="window.removeMember(${i})">Remove</button>
    `;
    list.appendChild(li);
  });
  const total = members.length * MEMBER_FEE;
  getEl('totalAmountDisplay').textContent = `₹ ${total}`;
   
  // Auto-Save to LocalStorage
  localStorage.setItem('eduHackMembers', JSON.stringify(members));
}

/* --- PAYMENT LOGIC --- */

// Dynamic QR Generator
function generateDynamicQR(amount) {
  const el = getEl('qrcode');
  el.innerHTML = ""; 
  // UPI Link: upi://pay?pa=ID&pn=NAME&am=AMOUNT&tn=NOTE
  const link = `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(UPI_NAME)}&am=${amount}&tn=EduHackReg`;
  new QRCode(el, { text: link, width: 120, height: 120, colorDark:"#000", colorLight:"#fff", correctLevel: QRCode.CorrectLevel.M });
}

getEl('payBtn').addEventListener('click', () => {
  if(members.length < 3) return showToast("Squad understrength (Min 3 members)");
  if(!getEl('teamName').value.trim()) return showToast("Identify your Squad Name");
   
  const amount = members.length * MEMBER_FEE;
  getEl('payModalAmount').textContent = `₹ ${amount}`;
  getEl('upiText').textContent = UPI_ID;
  generateDynamicQR(amount); // Generate QR
  toggleModal('paymentOverlay', true);
});

async function checkDuplicates(regnos, emails, txnId) {
  const results = { txn: false, reg: [], email: [] };
   
  // 1. Txn Check
  const txnSnap = await getDocs(query(collection(db, 'events', EVENT_ID, 'registrations'), where('transaction_id', '==', txnId)));
  if(!txnSnap.empty) results.txn = true;

  // 2. Reg Check
  if(regnos.length) {
    const regSnap = await getDocs(query(collection(db, 'events', EVENT_ID, 'registrations'), where('members_regnos', 'array-contains-any', regnos)));
    regSnap.forEach(d => {
      const data = d.data();
      data.members_regnos.filter(r => regnos.includes(r)).forEach(r => results.reg.push(r));
    });
  }

  // 3. Email Check
  if(emails.length) {
    const emailSnap = await getDocs(query(collection(db, 'events', EVENT_ID, 'registrations'), where('members_emails', 'array-contains-any', emails)));
    emailSnap.forEach(d => {
      const data = d.data();
      data.members_emails.filter(e => emails.includes(e)).forEach(e => results.email.push(e));
    });
  }
  return results;
}

getEl('paymentForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if(submitting) return;
   
  const btn = getEl('completePaymentBtn');
  btn.textContent = "Verifying Signal...";
  btn.disabled = true;
  submitting = true;

  try {
    const txnId = getEl('txnId').value.trim();
    const teamName = getEl('teamName').value.trim();
    const regnos = members.map(m => m.reg);
    const emails = members.map(m => m.email);

    const dupes = await checkDuplicates(regnos, emails, txnId);

    if(dupes.txn) throw new Error("Transaction ID used previously.");
    if(dupes.reg.length) throw new Error(`Already registered: ${dupes.reg.join(', ')}`);
    if(dupes.email.length) throw new Error(`Emails exists: ${dupes.email.join(', ')}`);

    const payload = {
      event: EVENT_ID,
      team_name: teamName,
      members,
      members_regnos: regnos,
      members_emails: emails,
      amount: members.length * MEMBER_FEE,
      status: 'submitted',
      paid_at: new Date().toISOString(),
      token: `EDH-${Date.now()}`,
      transaction_id: txnId,
      payer_name: getEl('payerName').value.trim() || null,
      upi_id: UPI_ID,
      verified: false,
      createdAt: serverTimestamp()
    };

    await setDoc(doc(collection(db, 'events', EVENT_ID, 'registrations')), payload);

    toggleModal('paymentOverlay', false);
    toggleModal('successOverlay', true);
    
    // CONFETTI
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ff0033', '#ffffff'] });
    playSound('success');

    // Reset Data & LocalStorage
    members = []; 
    localStorage.removeItem('eduHackMembers');
    renderMembers(); 
    getEl('regForm').reset(); 
    getEl('paymentForm').reset();

  } catch(err) {
    showToast(err.message, 'error');
  } finally {
    submitting = false;
    btn.textContent = "Confirm Transmission";
    btn.disabled = false;
  }
});
</script>
</body>
</html>
