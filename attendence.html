<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EduHack 2025 • Attendance</title>

<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
  --glass-bg: rgba(255, 255, 255, 0.08);
  --glass-border: rgba(255, 255, 255, 0.25);
  --glass-shadow: rgba(0, 0, 0, 0.4);
  --present: #34c759; /* iOS green */
  --absent: #ff3b30;  /* iOS red */
  font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif;
}
body {
  margin: 0;
  background: linear-gradient(135deg, #0d0d0f, #1b1c20);
  color: white;
  padding: 20px;
  -webkit-font-smoothing: antialiased;
}
.container {
  max-width: 1100px;
  margin: auto;
}
.card {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 20px;
  backdrop-filter: blur(30px) saturate(150%);
  -webkit-backdrop-filter: blur(30px) saturate(150%);
  box-shadow: 0 8px 32px var(--glass-shadow);
}
h2 {
  margin: 0 0 15px 0;
  font-size: 22px;
  font-weight: 700;
}
.download-btn {
  display: inline-block;
  margin-bottom: 15px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 600;
  border: none;
  border-radius: 14px;
  background: var(--glass-bg);
  color: white;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  cursor: pointer;
  transition: 0.2s;
}
.download-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 15px;
}
th, td {
  padding: 12px;
  text-align: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}
th {
  background: rgba(255, 255, 255, 0.05);
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 2;
}
td.member-col {
  text-align: left;
}
.status {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
}
.status.present {
  background: var(--present);
  color: #fff;
}
.status.absent {
  background: var(--absent);
  color: #fff;
}
.status.pending {
  background: rgba(255, 255, 255, 0.1);
  color: #ddd;
}
.small {
  font-size: 13px;
  opacity: 0.8;
}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>EduHack 2025 • Attendance</h2>
      <div class="small">10X Club – KARE • Kalasalingam Academy of Research and Education</div>
      
      <!-- Download button -->
      <button class="download-btn" onclick="downloadExcel()">⬇ Download as Excel</button>

      <table id="attendanceTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Team</th>
            <th>Member</th>
            <th>Reg No</th>
            <th>Oct 11<br>5:00 PM</th>
            <th>Oct 11<br>8:00 PM</th>
            <th>Oct 12<br>9:00 AM</th>
            <th>Oct 12<br>1:00 PM</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, query, orderBy, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBzEwEDcTDs2Y-NUAGZkhQJsFRg6MZxoYE",
  authDomain: "eduhack-432fd.firebaseapp.com",
  projectId: "eduhack-432fd",
  storageBucket: "eduhack-432fd.firebasestorage.app",
  messagingSenderId: "160252785408",
  appId: "1:160252785408:web:6a22e465982e3e510979e5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const EVENT_ID = "edu-hack-2025";
const ATT_SLOTS = [
  "2025-10-11-17:00",
  "2025-10-11-20:00",
  "2025-10-12-09:00",
  "2025-10-12-13:00"
];

const tbody = document.getElementById("tbody");

function renderAttendance(list) {
  tbody.innerHTML = "";
  let counter = 1;

  list.forEach(team => {
    if (!team.verified) return; // show only verified teams
    (team.members || []).forEach(member => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${counter++}</td>
        <td>${escapeHtml(team.team_name || "-")}</td>
        <td class="member-col">${escapeHtml(member.name || "-")}</td>
        <td>${escapeHtml(member.reg || "-")}</td>
        ${ATT_SLOTS.map(slot => {
          const status = team.attendance?.[slot];
          if (status === true) return `<td>Present</td>`;
          if (status === false) return `<td>Absent</td>`;
          return `<td>—</td>`;
        }).join("")}
      `;

      tbody.appendChild(tr);
    });
  });
}

// live listener
function startListener() {
  const col = collection(db, "events", EVENT_ID, "registrations");
  const q = query(col, orderBy("createdAt", "asc"));
  onSnapshot(q, snap => {
    const teams = [];
    snap.forEach(s => teams.push({ id: s.id, ...s.data() }));
    renderAttendance(teams);
  });
}
startListener();

function escapeHtml(s=""){ 
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;");
}

// Excel download
window.downloadExcel = function () {
  const table = document.getElementById("attendanceTable");
  const wb = XLSX.utils.table_to_book(table, {sheet:"Attendance"});
  XLSX.writeFile(wb, "EduHack-2025-Attendance.xlsx");
};
</script>
</body>
</html>
